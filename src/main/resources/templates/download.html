<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>BTCert</title>
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<!-- Bootstrap 4.0 alpha -->
	<link rel="stylesheet" href="../css/bootstrap.min.css">
	<!-- Own Theme style -->
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/loader.css">
	<link rel="stylesheet" href="../css/landing-page.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

	<!-- plugins -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
 
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	
</head>
<body>
<div class="header">
	<div class="container">
		<a class="logo" href="/"><img src="../images/logo.png" alt=""></a>
		<div class="header-navigation pull-right font-transform-inherit">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

				<ul class="nav navbar-nav navbar-right">
					<li><a href="/">Home</a></li>
					<li><a href="http://www.github.com">Download</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>

 <!-- Header -->
    <header class="intro-header">
      <div class="container">
        <div class="intro-message">
          <h1>Download Page</h1>
          <h3>Start your new certificate trip!</h3>
          <hr class="intro-divider">
          <ul class="list-inline intro-social-buttons">
            <li class="list-inline-item">
              <a href="#" class="btn btn-secondary btn-lg">
                <i class="fa fa-download"></i>
                <span class="network-name">Download Apps</span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="#" class="btn btn-secondary btn-lg">
                <i class="fa fa-github fa-fw"></i>
                <span class="network-name">Download Html</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </header>


<div class="footer">
	<div class="container">
		<div class="row row-p	b-md">
			<div class="col-md-4">
				<div class="gtco-widget">
					<h3 data-lang="footer-about-us">ABOUT</h3>
					<p data-lang="footer-about-us-des" style = "color:#ddd">
						This is a system that using the <a style = "color:#996671" href = "https://en.wikipedia.org/wiki/Blockchain">blockchain</a> and strong 
						<a style = "color:#996671" href = "https://en.wikipedia.org/wiki/Cryptography">cryptography</a> to create a certification infrastructure,
						which protecting authentic credential certification and reputation appear.
					</p>
				</div>
			</div>
			<div class="col-md-4 col-md-push-1">
				<div class="gtco-widget">
					<h3 data-lang="footer-links">LINKS</h3>
					<ul class="gtco-footer-links">
						<li><a href="#" data-lang="footer-links-1">Privacy Policy</a></li>
						<li><a href="#" data-lang="footer-links-2">Cookie Policy </a></li>
						<li><a href="#" data-lang="footer-links-3">Terms and Conditions</a></li>
						<li><a href="#" data-lang="footer-links-4">Q & A</a></li>
					</ul>
				</div>
			</div>
			<div class="col-md-4">
				<div class="gtco-widget">
					<h3 data-lang="footer-touch">CONTACT</h3>
					<ul class="gtco-quick-contact">
						<li> The University of Birmingham</li>
						<li> Edgbaston</li>
						<li> Birmingham B15 2TT</li>
						<li> United Kingdom</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="row copyright">
			<div class="col-md-12">
				<p class="pull-left">
					<small class="block">© 2017 IT Innovation Birmingham. All Rights Reserved.</small>
				</p>
				<p class="pull-right">
				</p>
				<ul class="gtco-social-icons pull-right">
					<li><a href="#"><i class="icon-github"></i></a></li>
					<li><a href="#"><i class="icon-facebook"></i></a></li>
					<li><a href="#"><i class="icon-linkedin"></i></a></li>
					<li><a href="#"><i class="icon-dribbble"></i></a></li>
				</ul>
				<p>
				</p>
			</div>
		</div>
	</div>
</div>


<!-- jQuery 2.2.3 -->
<script src="../jslib/jquery-3.2.1.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../jslib/bootstrap.min.js"></script>
<!-- Base64 Lib-->
<script src="../jslib/crypto-min.js"></script>

<script src="../jslib/jquery.base64.js"></script>

<script src="../jslib/jquery.jsonview.js"></script>

<script src ="../../jslib/jsbn.js"></script>
<script src ="../../jslib/jsencrypt.min.js"></script>
<script src ="../../jslib/crypto-sha256.js"></script>
<script src ="../../jslib/crypto-sha256-hmac.js"></script>
<script src ="../../jslib/ellipticcurve.js"></script>
<script src ="../../jslib/ripemd160.js"></script>
<script src ="../../jslib/sha512.js"></script>
<script src="../jslib/sweetalert.min.js"></script>


<script type="text/javascript">

 function toggleJson(){
	 $('#certsInfo').JSONView('toggle', 1);
 }

  function preview(){
	  var jsostr = document.getElementById('result').value;
      var jsonobj = JSON.parse(jsostr)
      $(".modal-edit").modal('show'); 		    	
      $("#certsInfo").JSONView({})
 	  $("#certsInfo").JSONView(jsonobj, { collapsed: true });
  }
  
  function verify(){
	  
	  //var authenticationCode = "3DWwmE19gHdv3xM3zPrVwqoRmbJQ6cCPHd";
      var authenticationCode = $("#authenticationCode").val();
	  
	  if(authenticationCode != "" && authenticationCode != null){
		   var jsostr = document.getElementById('result').value;
		   var jsonobj = JSON.parse(jsostr) 
		   var waithashstr = jsonobj.badge.name + jsonobj.badge.issuer.name + jsonobj.recipient.identity;
		   
		   var hash = Crypto.SHA256(waithashstr)
		   
		   merkleRoot = jsonobj.signature.merkleRoot;
		   targetHash = jsonobj.signature.targetHash;
		   proof = jsonobj.signature.proof;
		   
		   merkleRoot = jsonobj.signature.merkleRoot;
		   //merkleRoot = "6a4030393639376461383735646634326365386233343534353736363763613533616437336538383032386238616638323765373962323461333536643133633536";
		   anchorsId = jsonobj.signature.anchors[0].sourceId;
		   //anchorsId = "6b18dbb7ef357c1c9bd15d2ab59e375c7718da59424b10abf09a2647e331d582"
		  
		   ensureMerkleRootOnBlockchain(merkleRoot,anchorsId);
		   
		   checkFileContentHash(hash,targetHash)
		   
		   merkleProofVerify(proof,targetHash,merkleRoot);
		   
		   verifyTransactionIsBelongedToAddress(authenticationCode,anchorsId);
		   
		   var r_address = jsonobj.badge.revocationClaim.revocationAddress;
		   var rb_address = jsonobj.badge.revocationClaim.batchRevocationAddress;
		   verifyRevokedCerts(r_address,rb_address)
		   
		   var expires = jsonobj.badge.expires;
		   verifyExpiredCerts(expires);
       }else{
           swal("Oops...", "Please input the authentication code", "error");
       }
  }
  
  
  //输出结果
  function printResult(progress,result){
	  var output = [];
	  output.push('<tr><td class="span12"><strong>', progress, '</strong></td><td>', result, '</td></tr>');
      //document.getElementById('list').innerHTML = '<table class="table table-striped table-hover">' + output.join('') + '</table>' + document.getElementById('list').innerHTML;
  	  $("#resultTable").append(output.join(''))
  }
  
  //结果进行输出
  function inuptResult(flag,progress_sccess,result_seccess,progress_failure,result_failure){
	  if(flag){
    	  printResult(progress_sccess,result_seccess)
      }else{
    	  printResult(progress_failure,result_failure)
      }
  }
  
  //检查文件的完整性
  function checkFileContentHash(fileContentHash,targetHash){
	  inuptResult((fileContentHash == targetHash),"<i class='fa fa-check' aria-hidden='true'></i> Success: ","Check File Content Hash","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Check File Content Hash")
	  return fileContentHash == targetHash;
  }
  
  //检查merkle tree是否正确
  function merkleProofVerify(proof,targetHash,merkleRoot){
	  if(proof.length == 0){
		  inuptResult((targetHash == merkleRoot),"<i class='fa fa-check' aria-hidden='true'></i> Success:","Merkle Proof Verify","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Merkle Proof Verify")
		  return targetHash == merkleRoot; 
	  }
	  proofHash = targetHash;
	  for(var i = 0; i< proof.length; i++ ){
		  if(proof[i]["left"] != null){
			  proofHash = Crypto.SHA256(proof[i]["left"]+proofHash);
		  }else if(proof[i]["right"] != null){
			  proofHash = Crypto.SHA256(proofHash+proof[i]["right"]);
		  }else{
			    inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Success:","Merkle Proof Verify","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure:</span>","Merkle Proof Verify")
				return false;
		  }
	  }
	  
	  inuptResult((proofHash == merkleRoot),"<i class='fa fa-check' aria-hidden='true'></i> Success:","Merkle Proof Verify","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Merkle Proof Verify")
	  return proofHash == merkleRoot;
  }
  
  //验证merkleroot在blockchian上
  function ensureMerkleRootOnBlockchain(merkleRoot,anchorsId){
	  //merkleRoot = "6a4030393639376461383735646634326365386233343534353736363763613533616437336538383032386238616638323765373962323461333536643133633536";
	  var flag = false;
	  //6b18dbb7ef357c1c9bd15d2ab59e375c7718da59424b10abf09a2647e331d582
	  $.getJSON("https://btc.blockr.io/api/v1/tx/info/"+anchorsId,function(result){
		  
		  for(var i=0 ; i <result.data.vouts.length ; i++){
			  if(merkleRoot == result.data.vouts[i].extras.script){
				  flag = true;
				  break;
			  }
		  }
		  if(flag){
			  //处理其他情况
			  inuptResult(true,"<i class='fa fa-check' aria-hidden='true'></i> Success:","Check Merkle Root On Blockchain","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Check Merkle Root On Blockchain")
		  }else{
			  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Success:","Check Merkle Root On Blockchain","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Check Merkle Root On Blockchain")
		  }
	  }).fail(function(result) { 
		  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Success:","Check Merkle Root On Blockchain","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Failure: </span>","Check Merkle Root On Blockchain")
      })
  }
  
  //交易是否是否属于某个指定地址
  function verifyTransactionIsBelongedToAddress(authenticationAddress,anchorsId){
	  //3DWwmE19gHdv3xM3zPrVwqoRmbJQ6cCPHd
	  
 	  $.get("http://btc.blockr.io/api/v1/address/txs/"+authenticationAddress,function(result){
 		  
 		  var flag = false;
 		  if(result.status == 'error'){
			  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Belonged:","Transaction is belonged to school's address","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Not Belonged: </span>","Transaction is not belonged to school's address")
 		  }
		  
		  for(var i=0 ; i < result.data.txs.length ; i++){
			  if(anchorsId == result.data.txs[i].tx){
				  flag = true;
				  break;
			  }
		  }
		  
		  if(flag){
			  inuptResult(true,"<i class='fa fa-check' aria-hidden='true'></i> Belonged:","Transaction is belonged to school's address","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'>Not Belonged: </span>","Transaction is not belonged to school's address")
		  }else{
			  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Belonged:","Transaction is belonged to school's address","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Not Belonged: </span>","Transaction is not belonged to school's address")
		  }
	  }) 
 }
  
  //验证证书是否被回收
   function verifyRevokedCerts(r_address,rb_address){
	  $.getJSON(" https://blockchain.info/q/getsentbyaddress/"+rb_address,function(rb_result){
		  if(rb_result == 0){
			  $.getJSON(" https://blockchain.info/q/getsentbyaddress/"+r_address,function(r_result){
				  if(r_result == 0){
					  inuptResult(true,"<i class='fa fa-check' aria-hidden='true'></i> Not Revoked:","Certificate is not Revoked","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Revoked: </span>","Certificate is Revoked")
				  }else{
					//已经单独回收
					  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Not Revoked:","Certificate is not Revoked","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Revoked: </span>","Certificate is Revoked")
				  }
			  })
		  }else{
			  //已经批量回收
			  inuptResult(false,"<i class='fa fa-check' aria-hidden='true'></i> Not Revoked:","Certificate is not Revoked","<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Revoked:</span>","Certificate is Revoked")
		  }
	  })
  }
  
  // verifyRevokedCerts("1DYANQxUBJZxER133TdwfFnQh1ofZvWrgZ","1DYANQxUBJZxER133TdwfFnQh1ofZvWrgZ",alert)
  
  //验证是否有效
  function verifyExpiredCerts(expiredDate){
	  expiredDate = expiredDate.replace("-","/");//替换字符，变成标准格式    
	  var currentDate=new Date();//取今天的日期    
	  expiredDate = new Date(Date.parse(expiredDate));    
	 
	  if(expiredDate < currentDate){  
		inuptResult(true,"<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Expired: </span>","Certificate is Expired","<i class='fa fa-check' aria-hidden='true'></i> Not Expired:","Certificate is valid")
	    return true;
	  } 
	  inuptResult(false,"<i class='fa fa-times' aria-hidden='true'></i> <span style = 'color:red'> Expired: </span> ","Certificate is Expired","<i class='fa fa-check' aria-hidden='true'></i> Not Expired:","Certificate is valid")
	  return false;
  }

  
  /* ensureMerkleRootOnBlockchain("6a4030393639376461383735646634326365386233343534353736363763613533616437336538383032386238616638323765373962323461333536643133633536"
		  ,"6b18dbb7ef357c1c9bd15d2ab59e375c7718da59424b10abf09a2647e331d582",alert) */

   var drop_zone;

   document.getElementById('drop_zone').onclick = function () {
     document.getElementById('files').click();
     return false;
   };

   if ((typeof File !== 'undefined') && !File.prototype.slice) {
     if(File.prototype.webkitSlice) {
       File.prototype.slice = File.prototype.webkitSlice;
     }

     if(File.prototype.mozSlice) {
       File.prototype.slice = File.prototype.mozSlice;
     }
   }

   if (!window.File || !window.FileReader || !window.FileList || !window.Blob || !File.prototype.slice) {
     alert('File APIs are not fully supported in this browser. Please use latest Mozilla Firefox or Google Chrome.');
   }

   function handle_worker_event(id) {
     return function (event) {
       if (event.data.result) {
         $("#" + id).parent().html(event.data.result);
       } else {
         $("#" + id + ' .bar').css('width', event.data.block.end * 100 / event.data.block.file_size + '%');
       }
     };
   }


   function handle_file_select(event) {
     event.stopPropagation();
     event.preventDefault();

     var i, output, files, file, reader;

     files = event.dataTransfer ? event.dataTransfer.files : event.target.files;
     output = [];
    
     
     if (files.length <= 0) {
       return false;
     }
     
     var fr = new FileReader();

    
     fr.onload = function(e) { 
       var result = JSON.parse(e.target.result);
       var formatted = JSON.stringify(result, null, 2);
       document.getElementById('result').value = formatted;
     }

     fr.readAsText(files.item(0));
     
     
     /* swal({
            title: "Good Job",
            text: "Your file has been uploaded to local Syetem.",
            type: "success",
            showCancelButton: false,
            confirmButtonText: "OK",
            closeOnConfirm: false
     }) */
     
     
     $("#state").html("Your file has been uploaded to local syetem successfully.");
     $("#verifyDiv").show();
     
     
    /*  for (i = 0; i < files.length; i += 1) {
       file = files[i];
       output.push('<tr><td class="span12"><strong>', file.name, '</strong></td><td> (', file.type || 'n/a', ') - ', file.size, ' bytes</td></tr>');
       document.getElementById('list').innerHTML = '<table class="table table-striped table-hover">' + output.join('') + '</table>' + document.getElementById('list').innerHTML;
     } */
   }

   function handle_drag_over(event) {
     event.stopPropagation();
     event.preventDefault();
   }

   drop_zone = document.getElementById('drop_zone');
   drop_zone.addEventListener('dragover', handle_drag_over, false);
   drop_zone.addEventListener('drop', handle_file_select, false);
   document.getElementById('files').addEventListener('change', handle_file_select, false);
   
</script>

</body>
</html>
